# =============================================================================
# SliverUI Release Pipeline
# =============================================================================
# Builds the unified Docker image, runs a security scan, and creates a
# GitHub Release when a version tag (v*) is pushed.
#
# Jobs:
#   1. build          — build & push sliver-ui image to GHCR (+ Docker Hub)
#   2. security-scan  — Trivy vulnerability scan
#   3. create-release — GitHub Release with changelog
#
# Supports manual workflow_dispatch for ad-hoc builds.
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Custom image tag (e.g. "rc1", "hotfix-42")'
        required: false
        default: ''
      sliver_version:
        description: 'Sliver client version'
        required: false
        default: 'v1.6.10'

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  security-events: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/sliver-ui
  SLIVER_VERSION: ${{ github.event.inputs.sliver_version || 'v1.6.10' }}

jobs:
  # ===========================================================================
  # BUILD UNIFIED IMAGE
  # ===========================================================================
  build:
    name: Build & Push
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-qemu-action@v3

      - uses: docker/setup-buildx-action@v3

      # --- GHCR (always) ---
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- Docker Hub (optional — only if secrets are configured) ---
      - name: Log in to Docker Hub
        if: secrets.DOCKERHUB_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
          elif [[ -n "${{ github.event.inputs.image_tag }}" ]]; then
            echo "version=${{ github.event.inputs.image_tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=sha-$(echo ${{ github.sha }} | cut -c1-7)" >> "$GITHUB_OUTPUT"
          fi

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable=${{ github.ref_type == 'tag' }}
            type=raw,value=${{ github.event.inputs.image_tag }},enable=${{ github.event.inputs.image_tag != '' }}
          labels: |
            org.opencontainers.image.title=SliverUI
            org.opencontainers.image.description=Web GUI for Sliver C2 Framework

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            SLIVER_VERSION=${{ env.SLIVER_VERSION }}
          cache-from: type=gha,scope=unified
          cache-to: type=gha,mode=max,scope=unified
          provenance: true
          sbom: true

  # ===========================================================================
  # SECURITY SCAN
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build]
    continue-on-error: true
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.version }}'
          format: sarif
          output: trivy-results.sarif
          severity: HIGH,CRITICAL
          exit-code: '1'
          ignore-unfixed: true

      - name: Upload Trivy SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif
          category: trivy-sliver-ui

      - name: Print vulnerability summary
        if: always()
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.version }}'
          format: table
          severity: HIGH,CRITICAL
          ignore-unfixed: true

  # ===========================================================================
  # CREATE GITHUB RELEASE
  # ===========================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, security-scan]
    if: github.ref_type == 'tag'
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate release notes
        run: |
          PREVIOUS_TAG=$(git tag --sort=-version:refname | head -n 2 | tail -n 1)
          CURRENT_TAG="${GITHUB_REF_NAME}"
          VERSION="${CURRENT_TAG#v}"

          cat > release_notes.md << 'HEADER'
          ## Docker Image

          Pull from GitHub Container Registry:

          ```bash
          HEADER

          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}" >> release_notes.md

          cat >> release_notes.md << 'MIDDLE'
          ```

          Or deploy with docker-compose:

          ```bash
          MIDDLE

          echo "SLIVERUI_VERSION=${VERSION} docker compose -f docker-compose.hub.yml up -d" >> release_notes.md

          cat >> release_notes.md << 'FOOTER'
          ```

          ## What's Changed
          FOOTER

          if [ -n "${PREVIOUS_TAG}" ] && [ "${PREVIOUS_TAG}" != "${CURRENT_TAG}" ]; then
            git log "${PREVIOUS_TAG}..${CURRENT_TAG}" \
              --pretty=format:"- %s (%h)" \
              --no-merges >> release_notes.md
          else
            echo "- Initial release" >> release_notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: SliverUI ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
