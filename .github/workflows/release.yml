# =============================================================================
# SliverUI Release Pipeline
# =============================================================================
# Builds multi-platform Docker images and pushes to Docker Hub.
#
# Triggers:
#   - Push tag (v*) for releases
#   - Manual workflow_dispatch for ad-hoc builds
#
# Jobs:
#   1. build-backend  -- push sliverui-backend image
#   2. build-frontend -- push sliverui-frontend image  (parallel with 1)
#   3. security-scan  -- Trivy scan both images         (after 1+2)
#   4. create-release -- GitHub Release with changelog   (tags only)
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Custom image tag (e.g., "dev", "hotfix-123")'
        required: false
        default: ''
      sliver_version:
        description: 'Sliver client version for backend image'
        required: false
        default: 'v1.6.10'

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  security-events: write

env:
  SLIVER_VERSION: ${{ github.event.inputs.sliver_version || 'v1.6.10' }}

jobs:
  # ===========================================================================
  # BUILD BACKEND IMAGE
  # ===========================================================================
  build-backend:
    name: Build & Push Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/sliverui-backend
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable=${{ github.ref_type == 'tag' }}
            type=raw,value=${{ github.event.inputs.image_tag }},enable=${{ github.event.inputs.image_tag != '' }}
          labels: |
            org.opencontainers.image.title=SliverUI Backend
            org.opencontainers.image.description=FastAPI backend for SliverUI C2 management

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            SLIVER_VERSION=${{ env.SLIVER_VERSION }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend
          provenance: true
          sbom: true

  # ===========================================================================
  # BUILD FRONTEND IMAGE
  # ===========================================================================
  build-frontend:
    name: Build & Push Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/sliverui-frontend
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable=${{ github.ref_type == 'tag' }}
            type=raw,value=${{ github.event.inputs.image_tag }},enable=${{ github.event.inputs.image_tag != '' }}
          labels: |
            org.opencontainers.image.title=SliverUI Frontend
            org.opencontainers.image.description=React frontend for SliverUI C2 management

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend
          provenance: true
          sbom: true

  # ===========================================================================
  # SECURITY SCANNING
  # ===========================================================================
  security-scan:
    name: Security Scan (${{ matrix.image.name }})
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    continue-on-error: true
    permissions:
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        image:
          - name: sliverui-backend
          - name: sliverui-frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Determine image tag
        id: image-ref
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
            echo "tag=${VERSION}" >> $GITHUB_OUTPUT
          elif [[ -n "${{ github.event.inputs.image_tag }}" ]]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=sha-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          fi

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: '${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.image.name }}:${{ steps.image-ref.outputs.tag }}'
          format: 'sarif'
          output: 'trivy-${{ matrix.image.name }}.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          ignore-unfixed: true

      - name: Upload Trivy SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-${{ matrix.image.name }}.sarif'
          category: 'trivy-${{ matrix.image.name }}'

      - name: Print vulnerability summary
        if: always()
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: '${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.image.name }}:${{ steps.image-ref.outputs.tag }}'
          format: 'table'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true

  # ===========================================================================
  # CREATE GITHUB RELEASE
  # ===========================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, security-scan]
    if: github.ref_type == 'tag'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate release notes
        run: |
          PREVIOUS_TAG=$(git tag --sort=-version:refname | head -n 2 | tail -n 1)
          CURRENT_TAG="${GITHUB_REF_NAME}"
          VERSION="${CURRENT_TAG#v}"

          cat << EOF > release_notes.md
          ## Docker Images

          Pull pre-built images from Docker Hub:

          \`\`\`bash
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/sliverui-backend:${VERSION}
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/sliverui-frontend:${VERSION}
          \`\`\`

          Or deploy with docker-compose:

          \`\`\`bash
          SLIVERUI_VERSION=${VERSION} docker compose -f docker-compose.hub.yml up -d
          \`\`\`

          ## What's Changed
          EOF

          if [ -n "${PREVIOUS_TAG}" ] && [ "${PREVIOUS_TAG}" != "${CURRENT_TAG}" ]; then
            git log "${PREVIOUS_TAG}..${CURRENT_TAG}" \
              --pretty=format:"- %s (%h)" \
              --no-merges >> release_notes.md
          else
            echo "- Initial release" >> release_notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: SliverUI ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
